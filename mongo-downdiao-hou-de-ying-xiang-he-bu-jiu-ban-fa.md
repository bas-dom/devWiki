# 宕机的影响
Mongodb的服务如果挂掉了，直接影响全部的在线产品，包括国服的后台、demo后台、Service后台服务、ExpertContainer后台。总之，所有访问历史数据库或项目配置数据库的后台程序，都会受到影响。

# 修复方法
## Windows系统
Windows操作系统处理宕机问题很简单，以120.55.113.116这台windows server为例，打开Windows服务可以看到，该后台有mongo的后台服务，当服务挂掉的时候，它的状态会显示“已停止”。这时，只需要在对应的列表上右键，然后再弹出菜单上选择“开始”就能再次启动服务了。

要注意的是，虽然点击了开始，但是服务不一定能启动成功，这个是因为服务在崩溃的时候会给磁盘文件加锁，锁住的文件不能被重新载入。这种启动失败的情况就需要特殊的处理了，这个时候要打开磁盘上该服务对应的mongodb data目录，
可以看到文件名是和服务相对应的，我们进目录，可以看到里面有个mongod.lock,此时，手动删除掉这个文件，然后重复上面的启动步骤，就能启动mongo的服务了。

>注意，当启动的是历史数据库的时候，系统从崩溃状态恢复，需要一定的时间，不是即时能启动的，根据我的观察，这个过程最长可能需要几分钟，最好是查看系统的进程列表，如果能看到状态是“正在运行”，肯定代表服务已经启动了

注意，当启动的是历史数据库的时候，系统从崩溃状态恢复，需要一定的时间，不是即时能启动的，根据我的观察，这个过程最长可能需要几分钟，最好是查看系统的进程列表，如果能看到状态是“正在运行”，肯定代表服务已经启动了

## Linux系统
对于Linux系统，恢复就更简单了，敲入命令：
```
supervisor start mongo
```
就能启动，然后可以输入:
```
ps -e
```
命令来查看进程列表中是否存在mongod即可，如果发现启动失败的话，原因肯定也是出在mongod.lock这个文件上面了，可以删掉这个文件，再次启动。

>如果系统没有安装supervisord进程监控，那么需要手动运行mongod命令来启动mongo后台。

#日志处理
mongo的日子会不断的增大，最后连一半的文本工具都无法加载，这个时候就要用到mongo提供的命令来处理这个大的文件，原理是把现有的文件截断，然后从零开始存储，这样用户就能够对老的大文件进行处理了。superuser用户是我添加的最高级别的用户，只有这个用户才能处理系统级的核心任务，运行
```
db.runCommand({logRotate:1})
```
这个命令的含义是将该mongo实例现有的log文件备份，然后再另起一个新的文件存储log。mongo考虑到了日志文件的问题，所以给用户提供了这个命令来处理大的日志文件。

具体操作如下：
```
> use admin
switched to db admin
> db.auth('superuser','pwd')
1
> db.runCommand({logRotate:1})
{ "ok" : 1 }
```
执行完以上命令之后，会发现磁盘上多处了一个日志文件，这个就是被转存的文件，新的日志文件大小是0k，mongo会继续在这个文件上面写日志。
